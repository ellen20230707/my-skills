name: 每日股票推荐自动化
on:
  schedule:
    # UTC时区，对应北京时间 21:00（UTC+8）：0 13 * * *
    # UTC时区，对应北京时间 22:00（UTC+8）：0 14 * * *
    - cron: '0 13 * * 1-5'  # 仅工作日执行（周一到周五），避免周末无数据
    - cron: '0 14 * * 1-5'
  workflow_dispatch:  # 手动触发（方便测试）

jobs:
  run-stock-recommendation:
    runs-on: ubuntu-latest
    permissions:  # 新增：赋予提交代码的权限（解决git-auto-commit权限问题）
      contents: write
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 新增：拉取完整提交历史，避免git-auto-commit报错

      - name: 设置 Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy baostock

      # ========== 修复条件判断：兼容手动触发和定时触发 ==========
      - name: 执行A股数据更新
        # 条件：定时触发（13:00 UTC） 或 手动触发时强制执行
        if: github.event.schedule == '0 13 * * 1-5' || github.event_name == 'workflow_dispatch'
        run: |
          # 先检查脚本路径是否存在（调试用）
          ls -la ./skills/A_stock_data_download/
          # 执行数据更新脚本
          cd skills/A_stock_data_download
          python data_download.py

      - name: 执行MACD&成交量分析
        # 条件：定时触发（14:00 UTC） 或 手动触发时强制执行
        if: github.event.schedule == '0 14 * * 1-5' || github.event_name == 'workflow_dispatch'
        run: |
          ls -la ./skills/stock_macd_volumn/
          cd skills/stock_macd_volumn
          python daily_analysis.py

      - name: 生成每日推荐报告
        if: github.event.schedule == '0 14 * * 1-5' || github.event_name == 'workflow_dispatch'
        run: |
          ls -la ./skills/stock_daily_recommendation/
          cd skills/stock_daily_recommendation
          python daily_recommendation.py

      - name: 上传推荐报告到仓库
        if: github.event.schedule == '0 14 * * 1-5' || github.event_name == 'workflow_dispatch'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '自动更新：${{ github.run_id }} 股票推荐报告'
          file_pattern: 'skills/stock_daily_recommendation/recommendations/*'
          # 新增：指定提交用户（避免权限问题）
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
          commit_author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
