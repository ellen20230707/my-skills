name: æ‰‹åŠ¨æµ‹è¯•å®Œæ•´æµç¨‹

# ä»…æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      test_stock_limit:
        description: 'æµ‹è¯•è‚¡ç¥¨æ•°é‡é™åˆ¶ï¼ˆç•™ç©ºåˆ™å…¨éƒ¨åˆ†æžï¼‰'
        required: false
        type: string
        default: '100'
      skip_data_update:
        description: 'è·³è¿‡æ•°æ®æ›´æ–°ï¼ˆä»…æµ‹è¯•æŽ¨èç”Ÿæˆï¼‰'
        required: false
        type: boolean
        default: false

env:
  TZ: 'Asia/Shanghai'

jobs:
  test-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy baostock

      - name: æµ‹è¯•çŽ¯å¢ƒéªŒè¯
        run: |
          echo "## ðŸ§ª æµ‹è¯•çŽ¯å¢ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Pythonç‰ˆæœ¬**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **å½“å‰æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œç›®å½•**: $(pwd)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ•°æ®ç›®å½•
          if [ -d "Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®" ]; then
            stock_count=$(ls Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/*.csv 2>/dev/null | wc -l)
            echo "- **è‚¡ç¥¨æ–‡ä»¶æ•°**: $stock_count" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **è‚¡ç¥¨æ–‡ä»¶æ•°**: âš ï¸ æ•°æ®ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          fi

      # æ­¥éª¤1ï¼šæ•°æ®æ›´æ–°æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
      - name: æµ‹è¯•æ•°æ®æ›´æ–°
        if: ${{ !inputs.skip_data_update }}
        run: |
          echo "## ðŸ“¥ æµ‹è¯•æ•°æ®æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cd skills/stock_macd_volumn

          # ä½¿ç”¨æµ‹è¯•æ¨¡å¼ï¼ˆä»…æ›´æ–°å‰10åªè‚¡ç¥¨ï¼‰
          if python daily_data_updater.py --test --data-dir "../../Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®"; then
            echo "âœ… æ•°æ®æ›´æ–°æµ‹è¯•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æ•°æ®æ›´æ–°æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

      # æ­¥éª¤2ï¼šåˆ†æžæµ‹è¯•
      - name: æµ‹è¯•è¶‹åŠ¿åˆ†æž
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š æµ‹è¯•è¶‹åŠ¿åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cd skills/stock_macd_volumn

          # ä½¿ç”¨é™åˆ¶çš„è‚¡ç¥¨æ•°é‡è¿›è¡Œæµ‹è¯•
          if [ -n "${{ inputs.test_stock_limit }}" ]; then
            limit_arg="--limit ${{ inputs.test_stock_limit }}"
            echo "åˆ†æžè‚¡ç¥¨æ•°é™åˆ¶: ${{ inputs.test_stock_limit }}" >> $GITHUB_STEP_SUMMARY
          else
            limit_arg=""
            echo "åˆ†æžå…¨éƒ¨è‚¡ç¥¨" >> $GITHUB_STEP_SUMMARY
          fi

          if python stock_trend_analyzer.py --no-future $limit_arg; then
            echo "âœ… è¶‹åŠ¿åˆ†æžæµ‹è¯•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ è¶‹åŠ¿åˆ†æžæµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

      # æ­¥éª¤3ï¼šæŽ¨èç”Ÿæˆæµ‹è¯•
      - name: æµ‹è¯•æŽ¨èç”Ÿæˆ
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ æµ‹è¯•æŽ¨èç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cd skills/stock_daily_recommendation

          if python daily_recommendation.py; then
            echo "âœ… æŽ¨èç”Ÿæˆæµ‹è¯•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY

            # æ£€æŸ¥ç”Ÿæˆçš„æŠ¥å‘Š
            current_date=$(TZ=Asia/Shanghai date +%Y%m%d)
            if [ -f "recommendations/recommendation_${current_date}.txt" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“„ ç”Ÿæˆçš„æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -n 20 "recommendations/recommendation_${current_date}.txt" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "... (æŸ¥çœ‹å®Œæ•´å†…å®¹è¯·ä¸‹è½½Artifact)" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ æŽ¨èç”Ÿæˆæµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

      # æ­¥éª¤4ï¼šä¸Šä¼ æµ‹è¯•ç»“æžœ
      - name: ä¸Šä¼ æµ‹è¯•ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            skills/stock_macd_volumn/output/
            skills/stock_daily_recommendation/recommendations/
            skills/stock_daily_recommendation/logs/
          retention-days: 7

      - name: æµ‹è¯•æ€»ç»“
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æµ‹è¯•å®Œæˆï¼æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†æ—¥å¿—å’Œä¸‹è½½çš„Artifactäº†è§£ç»“æžœã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚æžœæµ‹è¯•æˆåŠŸï¼Œè¯´æ˜Žè‡ªåŠ¨åŒ–æµç¨‹é…ç½®æ­£ç¡®ï¼Œå¯ä»¥ç­‰å¾…å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œã€‚" >> $GITHUB_STEP_SUMMARY
