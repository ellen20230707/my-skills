name: åé¦ˆåˆ†æä¸è‡ªåŠ¨è°ƒä¼˜

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©18:30 GMT+8 = 10:30 UTC
  schedule:
    - cron: '30 10 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      feedback_date:
        description: 'åé¦ˆæ—¥æœŸ (YYYYMMDD, å¯é€‰ï¼Œé»˜è®¤ä¸ºæœ€æ–°)'
        required: false
        type: string

# è®¾ç½®æ—¶åŒº
env:
  TZ: 'Asia/Shanghai'

jobs:
  analyze-feedback:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # æˆäºˆå†™å…¥æƒé™ï¼Œå…è®¸æäº¤å’Œæ¨é€è°ƒä¼˜é…ç½®
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æ‹‰å–æœ€æ–°æ›´æ–°
        run: |
          git pull origin main || echo "Already up to date"

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: æ£€æŸ¥åé¦ˆæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        id: check-feedback
        run: |
          cd skills/stock_daily_recommendation/turning_feedback

          # æŸ¥æ‰¾æœ€æ–°çš„åé¦ˆæ–‡ä»¶
          LATEST_FILE=$(ls -t tuning_feedback_*.csv 2>/dev/null | head -n 1)

          if [ -z "$LATEST_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  æœªæ‰¾åˆ°åé¦ˆæ–‡ä»¶"
          else
            echo "found=true" >> $GITHUB_OUTPUT
            echo "filename=$LATEST_FILE" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°åé¦ˆæ–‡ä»¶: $LATEST_FILE"

            # æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼ˆLinuxå…¼å®¹ï¼‰
            FILE_DATE=$(stat -c %y "$LATEST_FILE" 2>/dev/null | cut -d' ' -f1 | tr -d '-' || date +%Y%m%d)
            TODAY=$(date +%Y%m%d)
            echo "file_date=$FILE_DATE" >> $GITHUB_OUTPUT
            echo "today=$TODAY" >> $GITHUB_OUTPUT
          fi

      - name: è¿è¡Œåé¦ˆåˆ†æ
        if: steps.check-feedback.outputs.found == 'true'
        id: run-analysis
        run: |
          cd skills/stock_daily_recommendation
          mkdir -p logs
          python run_feedback_analysis.py

          # æ£€æŸ¥åˆ†ææ˜¯å¦æˆåŠŸï¼ˆé€šè¿‡æ—¥å¿—ï¼‰
          if grep -q "åé¦ˆåˆ†æå®Œæˆ" logs/feedback_analysis.log 2>/dev/null; then
            echo "analysis_completed=true" >> $GITHUB_OUTPUT
          elif grep -q "æœªæ‰¾åˆ°æ¨èCSVæ–‡ä»¶" logs/feedback_analysis.log 2>/dev/null; then
            echo "analysis_completed=false" >> $GITHUB_OUTPUT
            echo "no_recommendation=true" >> $GITHUB_OUTPUT
          else
            echo "analysis_completed=false" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥è°ƒä¼˜ç»“æœ
        if: steps.check-feedback.outputs.found == 'true'
        id: check-tuning
        run: |
          cd skills/stock_daily_recommendation

          if [ -f "tuning_config.json" ]; then
            echo "âœ… è°ƒä¼˜é…ç½®å·²ç”Ÿæˆ"
            echo "ğŸ“Š é…ç½®å†…å®¹:"
            cat tuning_config.json | python -m json.tool
            echo "tuning_generated=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  è°ƒä¼˜é…ç½®æœªç”Ÿæˆ"
            echo "tuning_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤è°ƒä¼˜é…ç½®
        if: steps.check-tuning.outputs.tuning_generated == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # æ·»åŠ è°ƒä¼˜é…ç½®æ–‡ä»¶å’Œå†å²è¿½è¸ªæ–‡ä»¶ï¼ˆä»ä»“åº“æ ¹ç›®å½•ï¼‰
          git add skills/stock_daily_recommendation/tuning_config.json
          git add skills/stock_daily_recommendation/tuning_history.json

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ğŸ“ è°ƒä¼˜é…ç½®æ— å˜æ›´"
          else
            # æäº¤
            FEEDBACK_FILE="${{ steps.check-feedback.outputs.filename }}"
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')

            git commit -m "ğŸ”§ è‡ªåŠ¨è°ƒä¼˜: åŸºäº ${FEEDBACK_FILE} çš„åé¦ˆåˆ†æ" \
                       -m "" \
                       -m "ç”Ÿæˆæ—¶é—´: ${COMMIT_TIME}" \
                       -m "åé¦ˆæ–‡ä»¶: ${FEEDBACK_FILE}" \
                       -m "" \
                       -m "Co-Authored-By: GitHub Actions <actions@github.com>"

            # æ¨é€
            git push

            echo "âœ… è°ƒä¼˜é…ç½®å·²æäº¤åˆ°ä»“åº“"
          fi

      - name: ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ“Š åé¦ˆåˆ†ææ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-feedback.outputs.found }}" == "true" ]; then
            echo "### âœ… åé¦ˆæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- æ–‡ä»¶å: \`${{ steps.check-feedback.outputs.filename }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.run-analysis.outputs.no_recommendation }}" == "true" ]; then
              echo "### â„¹ï¸ ç­‰å¾…æ¨èæŠ¥å‘Šç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "åé¦ˆæ–‡ä»¶å·²å°±ç»ªï¼Œä½†è¿˜æœªæ‰¾åˆ°æ¨èCSVæ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**ä¸‹ä¸€æ­¥**ï¼š" >> $GITHUB_STEP_SUMMARY
              echo "1. ç­‰å¾…ä»Šæ™š22:00è‡ªåŠ¨ç”Ÿæˆæ¨èæŠ¥å‘Šï¼ˆåŒ…å«CSVæ ¼å¼ï¼‰" >> $GITHUB_STEP_SUMMARY
              echo "2. æ¨èç”Ÿæˆåï¼Œæ˜å¤©18:30ä¼šè‡ªåŠ¨åˆ†ææœ¬æ¬¡åé¦ˆ" >> $GITHUB_STEP_SUMMARY
              echo "3. æˆ–è€…å¯ä»¥æ‰‹åŠ¨è¿è¡Œæ¨èå·¥å…·ç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.check-tuning.outputs.tuning_generated }}" == "true" ]; then
              echo "### âœ… è°ƒä¼˜é…ç½®å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "æ–°çš„å‚æ•°é…ç½®å°†åœ¨ä»Šæ™š22:00çš„æ¨èç”Ÿæˆä¸­ç”Ÿæ•ˆã€‚" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### ğŸ“Š Gapåˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              if [ -f "skills/stock_daily_recommendation/logs/feedback_analysis.log" ]; then
                grep -A 3 "Gapåˆ†æå®Œæˆ" skills/stock_daily_recommendation/logs/feedback_analysis.log 2>/dev/null | tail -4 || echo "è¯¦è§å®Œæ•´æ—¥å¿—"
              fi
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              echo "#### ğŸ’¡ è°ƒä¼˜å»ºè®®" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              if [ -f "skills/stock_daily_recommendation/logs/feedback_analysis.log" ]; then
                grep -A 8 "ğŸ“Œ MIN_ENHANCED_SCORE" skills/stock_daily_recommendation/logs/feedback_analysis.log 2>/dev/null | head -9 || echo "è¯¦è§å®Œæ•´æ—¥å¿—"
              fi
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              echo "#### é…ç½®å†…å®¹" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              if [ -f "skills/stock_daily_recommendation/tuning_config.json" ]; then
                cat skills/stock_daily_recommendation/tuning_config.json >> $GITHUB_STEP_SUMMARY
              fi
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âš ï¸ è°ƒä¼˜é…ç½®ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "è¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ æœªæ‰¾åˆ°åé¦ˆæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·ç¡®ä¿åœ¨18:00å‰æäº¤åé¦ˆæ–‡ä»¶åˆ° \`turning_feedback/\` ç›®å½•ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ–‡ä»¶åæ ¼å¼: \`tuning_feedback_YYYYMMDD.csv\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: å‡†å¤‡ä¸Šä¼ æ–‡ä»¶
        if: always() && steps.check-feedback.outputs.found == 'true'
        run: |
          mkdir -p artifact_upload
          [ -f skills/stock_daily_recommendation/logs/feedback_analysis.log ] && cp skills/stock_daily_recommendation/logs/feedback_analysis.log artifact_upload/ || echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          [ -f skills/stock_daily_recommendation/tuning_config.json ] && cp skills/stock_daily_recommendation/tuning_config.json artifact_upload/ || echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          [ -f skills/stock_daily_recommendation/tuning_history.json ] && cp skills/stock_daily_recommendation/tuning_history.json artifact_upload/ || echo "å†å²æ–‡ä»¶ä¸å­˜åœ¨"

      - name: ä¸Šä¼ åˆ†ææ—¥å¿—
        if: always() && steps.check-feedback.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: feedback-analysis-logs
          path: artifact_upload/
          retention-days: 30
          if-no-files-found: warn
