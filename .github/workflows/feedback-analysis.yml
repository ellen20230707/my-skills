name: åé¦ˆåˆ†æä¸è‡ªåŠ¨è°ƒä¼˜

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©18:30 GMT+8 = 10:30 UTC
  schedule:
    - cron: '30 10 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      feedback_date:
        description: 'åé¦ˆæ—¥æœŸ (YYYYMMDD, å¯é€‰ï¼Œé»˜è®¤ä¸ºæœ€æ–°)'
        required: false
        type: string

# è®¾ç½®æ—¶åŒº
env:
  TZ: 'Asia/Shanghai'

jobs:
  analyze-feedback:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æ‹‰å–æœ€æ–°æ›´æ–°
        run: |
          git pull origin main || echo "Already up to date"

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: æ£€æŸ¥åé¦ˆæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        id: check-feedback
        run: |
          cd skills/stock_daily_recommendation/turning_feedback

          # æŸ¥æ‰¾æœ€æ–°çš„åé¦ˆæ–‡ä»¶
          LATEST_FILE=$(ls -t tuning_feedback_*.csv 2>/dev/null | head -n 1)

          if [ -z "$LATEST_FILE" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  æœªæ‰¾åˆ°åé¦ˆæ–‡ä»¶"
          else
            echo "found=true" >> $GITHUB_OUTPUT
            echo "filename=$LATEST_FILE" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°åé¦ˆæ–‡ä»¶: $LATEST_FILE"

            # æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼ˆLinuxå…¼å®¹ï¼‰
            FILE_DATE=$(stat -c %y "$LATEST_FILE" 2>/dev/null | cut -d' ' -f1 | tr -d '-' || date +%Y%m%d)
            TODAY=$(date +%Y%m%d)
            echo "file_date=$FILE_DATE" >> $GITHUB_OUTPUT
            echo "today=$TODAY" >> $GITHUB_OUTPUT
          fi

      - name: è¿è¡Œåé¦ˆåˆ†æ
        if: steps.check-feedback.outputs.found == 'true'
        run: |
          cd skills/stock_daily_recommendation
          mkdir -p logs
          python run_feedback_analysis.py

      - name: æ£€æŸ¥è°ƒä¼˜ç»“æœ
        if: steps.check-feedback.outputs.found == 'true'
        id: check-tuning
        run: |
          cd skills/stock_daily_recommendation

          if [ -f "tuning_config.json" ]; then
            echo "âœ… è°ƒä¼˜é…ç½®å·²ç”Ÿæˆ"
            echo "ğŸ“Š é…ç½®å†…å®¹:"
            cat tuning_config.json | python -m json.tool
            echo "tuning_generated=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  è°ƒä¼˜é…ç½®æœªç”Ÿæˆ"
            echo "tuning_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤è°ƒä¼˜é…ç½®
        if: steps.check-tuning.outputs.tuning_generated == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # æ·»åŠ è°ƒä¼˜é…ç½®æ–‡ä»¶ï¼ˆä»ä»“åº“æ ¹ç›®å½•ï¼‰
          git add skills/stock_daily_recommendation/tuning_config.json

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ğŸ“ è°ƒä¼˜é…ç½®æ— å˜æ›´"
          else
            # æäº¤
            FEEDBACK_FILE="${{ steps.check-feedback.outputs.filename }}"
            git commit -m "ğŸ”§ è‡ªåŠ¨è°ƒä¼˜: åŸºäº ${FEEDBACK_FILE} çš„åé¦ˆåˆ†æ

ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')
åé¦ˆæ–‡ä»¶: ${FEEDBACK_FILE}

Co-Authored-By: GitHub Actions <actions@github.com>"

            # æ¨é€
            git push

            echo "âœ… è°ƒä¼˜é…ç½®å·²æäº¤åˆ°ä»“åº“"
          fi

      - name: ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ“Š åé¦ˆåˆ†ææ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-feedback.outputs.found }}" == "true" ]; then
            echo "### âœ… åé¦ˆæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- æ–‡ä»¶å: \`${{ steps.check-feedback.outputs.filename }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check-tuning.outputs.tuning_generated }}" == "true" ]; then
              echo "### âœ… è°ƒä¼˜é…ç½®å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "æ–°çš„å‚æ•°é…ç½®å°†åœ¨ä»Šæ™š22:00çš„æ¨èç”Ÿæˆä¸­ç”Ÿæ•ˆã€‚" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### é…ç½®å†…å®¹" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              if [ -f "skills/stock_daily_recommendation/tuning_config.json" ]; then
                cat skills/stock_daily_recommendation/tuning_config.json >> $GITHUB_STEP_SUMMARY
              fi
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âš ï¸ è°ƒä¼˜é…ç½®ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "è¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ æœªæ‰¾åˆ°åé¦ˆæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·ç¡®ä¿åœ¨18:00å‰æäº¤åé¦ˆæ–‡ä»¶åˆ° \`turning_feedback/\` ç›®å½•ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ–‡ä»¶åæ ¼å¼: \`tuning_feedback_YYYYMMDD.csv\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: å‡†å¤‡ä¸Šä¼ æ–‡ä»¶
        if: always() && steps.check-feedback.outputs.found == 'true'
        run: |
          mkdir -p artifact_upload
          [ -f skills/stock_daily_recommendation/logs/feedback_analysis.log ] && cp skills/stock_daily_recommendation/logs/feedback_analysis.log artifact_upload/ || echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          [ -f skills/stock_daily_recommendation/tuning_config.json ] && cp skills/stock_daily_recommendation/tuning_config.json artifact_upload/ || echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"

      - name: ä¸Šä¼ åˆ†ææ—¥å¿—
        if: always() && steps.check-feedback.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: feedback-analysis-logs
          path: artifact_upload/
          retention-days: 30
          if-no-files-found: warn
