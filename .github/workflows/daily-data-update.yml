name: æ¯æ—¥è‚¡ç¥¨æ•°æ®æ›´æ–°

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©21:00 GMT+8 (13:00 UTC)
  schedule:
    - cron: '0 13 * * *'  # UTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´21:00

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      date:
        description: 'æŒ‡å®šæ›´æ–°æ—¥æœŸ (YYYY-MM-DD)ï¼Œç•™ç©ºåˆ™ä½¿ç”¨æœ€è¿‘äº¤æ˜“æ—¥'
        required: false
        type: string

# è®¾ç½®æ—¶åŒºçŽ¯å¢ƒå˜é‡
env:
  TZ: 'Asia/Shanghai'  # è®¾ç½®ä¸ºGMT+8æ—¶åŒº

jobs:
  update-data:
    runs-on: ubuntu-latest

    # æŽˆäºˆå†™å…¥æƒé™ï¼Œå…è®¸æäº¤å’ŒæŽ¨é€æ•°æ®æ›´æ–°
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œä¾¿äºŽæäº¤

      # 2. è®¾ç½®PythonçŽ¯å¢ƒ
      - name: è®¾ç½®Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # ç¼“å­˜pipä¾èµ–

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy baostock

      # 4. æ£€æŸ¥æ•°æ®ç›®å½•
      - name: æ£€æŸ¥æ•°æ®ç›®å½•
        run: |
          if [ ! -d "Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®" ]; then
            echo "âŒ é”™è¯¯: æ•°æ®ç›®å½•ä¸å­˜åœ¨"
            echo "è¯·å…ˆåœ¨æœ¬åœ°è¿è¡Œ skills/A_stock_data_download/a_stock_download_baostock.py"
            echo "ç„¶åŽå°† Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/ ç›®å½•æäº¤åˆ°ä»“åº“"
            exit 1
          fi

          echo "âœ“ æ•°æ®ç›®å½•å­˜åœ¨"
          echo "è‚¡ç¥¨æ–‡ä»¶æ•°: $(ls Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/*.csv 2>/dev/null | wc -l)"

      # 5. è¿è¡Œæ•°æ®æ›´æ–°è„šæœ¬
      - name: æ›´æ–°è‚¡ç¥¨æ•°æ®
        run: |
          cd skills/stock_macd_volumn

          # å¦‚æžœæ‰‹åŠ¨æŒ‡å®šäº†æ—¥æœŸï¼Œä½¿ç”¨æŒ‡å®šæ—¥æœŸï¼›å¦åˆ™è‡ªåŠ¨èŽ·å–æœ€è¿‘äº¤æ˜“æ—¥
          if [ -n "${{ github.event.inputs.date }}" ]; then
            python daily_data_updater.py --date "${{ github.event.inputs.date }}" \
              --data-dir "../../Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®"
          else
            python daily_data_updater.py --data-dir "../../Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®"
          fi

      # 6. æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      - name: æ£€æŸ¥æ›´æ–°çŠ¶æ€
        id: check_changes
        run: |
          if git diff --quiet Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ æ— æ•°æ®æ›´æ–°ï¼ˆå·²æ˜¯æœ€æ–°æˆ–éžäº¤æ˜“æ—¥ï¼‰"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ æ•°æ®å·²æ›´æ–°"

            # ç»Ÿè®¡æ›´æ–°çš„æ–‡ä»¶æ•°
            changed_files=$(git diff --name-only Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/ | wc -l)
            echo "æ›´æ–°æ–‡ä»¶æ•°: $changed_files"
          fi

      # 7. æäº¤æ›´æ–°çš„æ•°æ®
      - name: æäº¤æ•°æ®æ›´æ–°
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # æ·»åŠ æ›´æ–°çš„CSVæ–‡ä»¶
          git add Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/*.csv

          # æäº¤
          current_date=$(TZ=Asia/Shanghai date +%Y-%m-%d)
          git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°è‚¡ç¥¨æ•°æ® - ${current_date}"

          # å…ˆæ‹‰å–è¿œç¨‹æ›´æ”¹ï¼ˆä½¿ç”¨rebaseé¿å…åˆå¹¶æäº¤ï¼‰
          git pull --rebase origin main || {
            echo "âš ï¸ Pullå¤±è´¥ï¼Œå°è¯•è§£å†³å†²çª..."
            # å¦‚æžœæœ‰å†²çªï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ›´æ”¹ï¼ˆæ•°æ®æ–‡ä»¶ï¼‰
            git checkout --ours Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/*.csv
            git add Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/*.csv
            git rebase --continue || git rebase --skip
          }

          # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… æŽ¨é€æˆåŠŸ"
              break
            else
              echo "âš ï¸ æŽ¨é€å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              sleep 2
              git pull --rebase origin main || true
            fi
          done

      # 8. ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
      - name: ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“Š æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.date }}" ]; then
            echo "- **æŒ‡å®šæ—¥æœŸ**: ${{ github.event.inputs.date }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "- **æ›´æ–°çŠ¶æ€**: âœ… æˆåŠŸæ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **æ›´æ–°çŠ¶æ€**: â„¹ï¸ æ— æ›´æ–°ï¼ˆå·²æ˜¯æœ€æ–°æˆ–éžäº¤æ˜“æ—¥ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹è¯¦ç»†æ—¥å¿—è¯·å±•å¼€ä¸Šæ–¹çš„æ­¥éª¤ã€‚" >> $GITHUB_STEP_SUMMARY
