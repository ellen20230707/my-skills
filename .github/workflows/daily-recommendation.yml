name: æ¯æ—¥è‚¡ç¥¨æ¨èç”Ÿæˆ

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©22:00 GMT+8 (14:00 UTC)
  schedule:
    - cron: '0 14 * * *'  # UTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´22:00

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # åœ¨æ•°æ®æ›´æ–°å®Œæˆåè‡ªåŠ¨è§¦å‘
  workflow_run:
    workflows: ["æ¯æ—¥è‚¡ç¥¨æ•°æ®æ›´æ–°"]
    types:
      - completed

# è®¾ç½®æ—¶åŒºç¯å¢ƒå˜é‡
env:
  TZ: 'Asia/Shanghai'  # è®¾ç½®ä¸ºGMT+8æ—¶åŒº

jobs:
  generate-recommendation:
    runs-on: ubuntu-latest
    # åªåœ¨æ•°æ®æ›´æ–°æˆåŠŸåè¿è¡Œï¼ˆå¦‚æœæ˜¯workflow_runè§¦å‘ï¼‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    # æˆäºˆå†™å…¥æƒé™ï¼Œå…è®¸æäº¤å’Œæ¨é€ä»£ç 
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # å¦‚æœæ˜¯workflow_runè§¦å‘ï¼Œéœ€è¦æ‹‰å–æœ€æ–°çš„æ•°æ®æ›´æ–°
      - name: æ‹‰å–æœ€æ–°æ›´æ–°
        if: github.event_name == 'workflow_run'
        run: |
          git pull origin main

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy baostock

      # 4. éªŒè¯æˆ–ä¸‹è½½æ•°æ®
      - name: éªŒè¯æ•°æ®ç›®å½•
        run: |
          if [ ! -d "Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®" ]; then
            echo "âš ï¸  æ•°æ®ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦é¦–æ¬¡è¿è¡Œæ•°æ®æ›´æ–°"
            echo "è¿™æ˜¯æ­£å¸¸æƒ…å†µ - æ•°æ®ç›®å½•å°šæœªæäº¤åˆ°ä»“åº“"
            echo ""
            echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
            echo "1. è¿è¡Œæ•°æ®æ›´æ–°å·¥ä½œæµï¼ˆdaily-data-updateï¼‰"
            echo "2. æˆ–åœ¨æœ¬åœ°æäº¤æ•°æ®ç›®å½•åˆ° Git"
            echo ""
            exit 1
          fi

          stock_count=$(ls Aè‚¡è¿‘10å¹´æ—¥çº¿æ•°æ®/*.csv 2>/dev/null | wc -l)
          echo "âœ“ æ•°æ®ç›®å½•å­˜åœ¨"
          echo "è‚¡ç¥¨æ–‡ä»¶æ•°: $stock_count"

          if [ "$stock_count" -lt 100 ]; then
            echo "âš ï¸  è­¦å‘Š: è‚¡ç¥¨æ–‡ä»¶æ•°é‡è¿‡å°‘ ($stock_count < 100)"
            echo "å»ºè®®è¿è¡Œæ•°æ®æ›´æ–°å·¥ä½œæµ"
          fi

      # 5. è¿è¡Œæ¨èç”Ÿæˆè„šæœ¬
      - name: ç”Ÿæˆæ¨èæŠ¥å‘Š
        run: |
          cd skills/stock_daily_recommendation
          python daily_recommendation.py

      # 6. åˆ›å»ºæ¨èæŠ¥å‘Šç›®å½•ç»“æ„
      - name: æ•´ç†æ¨èæŠ¥å‘Š
        run: |
          # ç¡®ä¿recommendationsç›®å½•å­˜åœ¨
          mkdir -p skills/stock_daily_recommendation/recommendations

          # ç§»åŠ¨æˆ–å¤åˆ¶æ—¥å¿—æ–‡ä»¶
          if [ -f skills/stock_daily_recommendation/logs/recommendation.log ]; then
            echo "âœ“ æ—¥å¿—æ–‡ä»¶å·²ç”Ÿæˆ"
          fi

          # ç»Ÿè®¡ç”Ÿæˆçš„æŠ¥å‘Š
          report_count=$(ls skills/stock_daily_recommendation/recommendations/recommendation_*.txt 2>/dev/null | wc -l)
          echo "ç”ŸæˆæŠ¥å‘Šæ•°: $report_count"

      # 7. æäº¤æ¨èæŠ¥å‘Š
      - name: æäº¤æ¨èæŠ¥å‘Š
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # æ·»åŠ æ¨èæŠ¥å‘Šå’Œæ—¥å¿—
          git add skills/stock_daily_recommendation/recommendations/
          git add skills/stock_daily_recommendation/logs/
          git add skills/stock_macd_volumn/output/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ğŸ“ æ— æ–°æŠ¥å‘Šç”Ÿæˆ"
          else
            current_date=$(TZ=Asia/Shanghai date +%Y-%m-%d)
            git commit -m "ğŸ“Š ç”Ÿæˆæ¯æ—¥æ¨èæŠ¥å‘Š - ${current_date}"
            git push
            echo "âœ“ æ¨èæŠ¥å‘Šå·²æäº¤"
          fi

      # 8. ç”ŸæˆæŠ¥å‘Šæ‘˜è¦
      - name: ç”ŸæˆæŠ¥å‘Šæ‘˜è¦
        if: always()
        run: |
          current_date=$(TZ=Asia/Shanghai date +%Y%m%d)

          echo "## ğŸ“Š æ¯æ—¥æ¨èæŠ¥å‘Šæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ—¶é—´**: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ˜¯å¦æœ‰æ¨èæŠ¥å‘Š
          if [ -f "skills/stock_daily_recommendation/recommendations/recommendation_${current_date}.txt" ]; then
            echo "### âœ… æŠ¥å‘Šå·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # æå–æ–‡æœ¬æŠ¥å‘Šçš„å‰30è¡Œä½œä¸ºé¢„è§ˆ
            echo "#### ğŸ“ æŠ¥å‘Šé¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 30 "skills/stock_daily_recommendation/recommendations/recommendation_${current_date}.txt" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "... (æŸ¥çœ‹å®Œæ•´æŠ¥å‘Šè¯·è®¿é—®ä»“åº“æ–‡ä»¶)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # æ·»åŠ æŠ¥å‘Šé“¾æ¥
            echo "#### ğŸ“‚ æŠ¥å‘Šæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [ğŸ“„ æ–‡æœ¬æŠ¥å‘Š](../blob/main/skills/stock_daily_recommendation/recommendations/recommendation_${current_date}.txt)" >> $GITHUB_STEP_SUMMARY
            echo "- [ğŸŒ HTMLæŠ¥å‘Š](../blob/main/skills/stock_daily_recommendation/recommendations/recommendation_${current_date}.html)" >> $GITHUB_STEP_SUMMARY
            echo "- [ğŸ“Š JSONæ•°æ®](../blob/main/skills/stock_daily_recommendation/recommendations/recommendation_${current_date}.json)" >> $GITHUB_STEP_SUMMARY

          else
            echo "### âš ï¸ æŠ¥å‘Šæœªç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å¯èƒ½åŸå› ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- æ•°æ®æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "- æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨" >> $GITHUB_STEP_SUMMARY
            echo "- è„šæœ¬æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      # 9. è®¾ç½®æ—¥æœŸæ—¶é—´å˜é‡ï¼ˆç”¨äºé‚®ä»¶ï¼‰
      - name: è®¾ç½®æ—¥æœŸæ—¶é—´å˜é‡
        id: set-env
        run: |
          echo "date=$(TZ=Asia/Shanghai date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "time=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      # 10. å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆé™„å¸¦TXTæŠ¥å‘Šï¼‰
      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ğŸ“Š æ¯æ—¥è‚¡ç¥¨æ¨èæŠ¥å‘Š - ${{ steps.set-env.outputs.date }}
          to: 22894196@qq.com
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            æ‚¨å¥½ï¼

            é™„ä»¶æ˜¯ä»Šæ—¥çš„Aè‚¡æ¨èæŠ¥å‘Šï¼ˆ${{ steps.set-env.outputs.date }}ï¼‰ã€‚

            æŠ¥å‘ŠåŒ…å«åŸºäºMACDã€æˆäº¤é‡ã€å‡çº¿ç­‰æŠ€æœ¯æŒ‡æ ‡ç­›é€‰å‡ºçš„æ½œåŠ›è‚¡ç¥¨ã€‚

            è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹é™„ä»¶ã€‚

            ---
            ğŸ¤– ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
            ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š${{ steps.set-env.outputs.time }}
          attachments: skills/stock_daily_recommendation/recommendations/recommendation_*.txt
          ignore_cert: false
          convert_markdown: false

      # 11. ä¸Šä¼ æŠ¥å‘Šä½œä¸ºArtifactï¼ˆå¯é€‰ï¼Œç”¨äºä¸‹è½½ï¼‰
      - name: ä¸Šä¼ æŠ¥å‘ŠArtifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: recommendation-reports
          path: |
            skills/stock_daily_recommendation/recommendations/recommendation_*.txt
            skills/stock_daily_recommendation/recommendations/recommendation_*.html
            skills/stock_daily_recommendation/recommendations/recommendation_*.json
          retention-days: 30  # ä¿ç•™30å¤©
